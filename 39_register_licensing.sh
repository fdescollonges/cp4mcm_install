# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# Create Demo Menus
#
# V1.0 
#
# Â©2020 nikh@ch.ibm.com
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"

source ./99_config-global.sh


# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# Do Not Edit Below
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"



headerModuleFileBegin "Register License Advisor " $0


# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# INSTALL CHECKS
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
header3Begin "Install Checks"

        getClusterFQDN

        getInstallPath

header3End



# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# PREREQUISITES
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
header3Begin "Running Prerequisites" "rocket"

        
        __output " ${wrench} Create Config Directory"
          export SCRIPT_PATH=$(pwd)
          #rm -r $INSTALL_PATH/* 
          mkdir -p $INSTALL_PATH 
          cd $INSTALL_PATH
        __output "    ${GREEN}  OK${NC}"
        __output "  "
        

        kubectl create secret docker-registry ibm-license-advisor-sender-registry --docker-server=$ENTITLED_REGISTRY --docker-username=$ENTITLED_REGISTRY_USER --docker-password=$ENTITLED_REGISTRY_KEY -n ibm-common-services


        __output " ${wrench} Getting configuration"

        export LICENSE_SERVICE_URL=$(kubectl get route ibm-licensing-service-instance -n ibm-common-services -o jsonpath='{.spec.host}')
        export LICENSE_ADVISOR_URL=$(kubectl get route ibm-license-advisor-instance -n kube-system -o jsonpath='{.spec.host}')
        export LICENSE_ADVISOR_TOKEN=$(kubectl get secret ibm-license-advisor-token -n kube-system -o jsonpath='{.data.token}' | base64 -d)
        export CLUSTER_NAME=$(kubectl config current-context)
        export CLUSTER_ID=$(kubectl config current-context | base64)



        # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        # Get license-sender.yaml template
        # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        cp $SCRIPT_PATH/tools/0_prepare/license-sender.yaml ./license-sender.yaml

        # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        # Adapt manageiq-external-auth-openidc.conf FIle
        # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        __output " ${GREEN}Adapt license-sender.yaml File${NC}"

        ${SED} -i "s@<License Advisor URL>@$LICENSE_ADVISOR_URL@" license-sender.yaml
        ${SED} -i "s@<License Advisor token>@$LICENSE_ADVISOR_TOKEN@" license-sender.yaml
        ${SED} -i "s@<License Service hostname>@$LICENSE_SERVICE_URL@" license-sender.yaml
        ${SED} -i "s@<Cluster ID>@$CLUSTER_ID@" license-sender.yaml
        ${SED} -i "s@<Cluster name>@$CLUSTER_NAME@" license-sender.yaml
    


        __output " ${GREEN}Current license-sender.yaml file for installation${NC}"
        __output " ${GREEN}Please Check if it looks OK${NC}"
        __output " ${ORANGE}^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^${NC}"
        __output " ${ORANGE}vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv${NC}"
        __output "  "
                cat license-sender.yaml
        __output "  "

header3End





# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# INSTALL
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------

header3Begin "Installing XYZ" "rocket"

         kubectl create -n ibm-common-services -f license-sender.yaml

header3End

headerModuleFileEnd "Register License Advisor " $0



