# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# Install Script for Infrastructure Management
#
# V1.0 
#
# Â©2020 nikh@ch.ibm.com
#
# https://cloud.ibm.com/docs/cloud-pak-multicloud-management?topic=cloud-pak-multicloud-management-cf-getting-started
#
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"

source ./99_config-global.sh

export SCRIPT_PATH=$(pwd)

# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# Do Not Edit Below
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"

headerModuleFileBegin "Post-Install Infrastructure VM" $0


# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# Define some Stuff
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
header3Begin "Installation Checks"

        getInstallPath 

        getClusterFQDN

        export MIQ_URL=inframgmtinstall.$CLUSTER_NAME

        # export CLIENT_ID=YWRtaW51c2Vy   # adminuser
        export CLIENT_ID=$(echo adminuser | base64)      
        #export CLIENT_SECRET="bXlzdXBlcnNlY3RyZXQ="   # mysupersectret
        export CLIENT_SECRET=$(echo $MCM_PASSWORD | base64) 


        checkAlreadyInstalled app=iminstall management-infrastructure-management
        if [[ $ALREADY_INSTALLED == 1 ]];
        then
            __output "    ${RED}${cross}Infrastructure VM already installed! Skipping...${NC}"
            exit 0
        fi

header3End



# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# PREREQUISITES
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
header3Begin "Running Prerequisites" "rocket"

        __output "---------------------------------------------------------------------------------------------------------------------------"

        export SCRIPT_PATH=$(pwd)

        __output "---------------------------------------------------------------------------------------------------------------------------"
        __output " Create Config Directory"
          rm -r $INSTALL_PATH/* 
          mkdir -p $INSTALL_PATH 
          cd $INSTALL_PATH
        __output "    ${GREEN}  OK${NC}"
        __output "  "


header3End



# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Adapt Config Files for Infrastructure VM
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
header3Begin "Adapt Config Files for Infrastructure VM" "magnifying"


        # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        # Get manageiq-external-auth-openidc.conf template
        # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        cp $SCRIPT_PATH/tools/infra/imconnectionsecret.yaml ./imconnectionsecret.yaml

        # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        # Adapt manageiq-external-auth-openidc.conf FIle
        # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        __output " ${GREEN}Adapt imconnectionsecret.yaml File${NC}"

        ${SED} -i "s@IM_HTTPD_ROUTE@$MIQ_URL@" imconnectionsecret.yaml
        ${SED} -i "s@CP4MCM_CONSOLE_ROUTE@$MCM_SERVER@" imconnectionsecret.yaml

        ${SED} -i "s/CLIENT_SECRET/$CLIENT_SECRET/" imconnectionsecret.yaml
        ${SED} -i "s/CLIENT_ID/$CLIENT_ID/" imconnectionsecret.yaml


      # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        # Get manageiq-external-auth-openidc.conf template
        # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        cp $SCRIPT_PATH/tools/infra/connection.yaml ./connection.yaml

        # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        # Adapt manageiq-external-auth-openidc.conf FIle
        # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        __output " ${GREEN}Create Custom Resource File${NC}"


        # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        # Get registration.json template
        # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        cp $SCRIPT_PATH/tools/infra/registration.json ./registration.json

        # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        # Adapt registration.json FIle
        # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        __output " ${GREEN}Adapt registration.json File${NC}"

        ${SED} -i "s@ICP_PROXY_URL@$MCM_PROXY@" registration.json
        ${SED} -i "s@CP4MCM_CONSOLE_ROUTE@$MCM_SERVER@" registration.json
        ${SED} -i "s@IM_HTTPD_ROUTE@$MIQ_URL@" registration.json
       
        ${SED} -i "s/CLIENT_ID/$CLIENT_ID/" registration.json
        ${SED} -i "s/CLIENT_SECRET/$CLIENT_SECRET/" registration.json


    # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        # Get iminstall.yaml template
        # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        cp $SCRIPT_PATH/tools/infra/iminstall.yaml ./iminstall.yaml

        # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        # Adapt iminstall.yaml FIle
        # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        __output " ${GREEN}Adapt iminstall.yaml File${NC}"

        ${SED} -i "s@IM_HTTPD_ROUTE@$MIQ_URL@" iminstall.yaml
       




#__output " ${GREEN}Current connection.yaml file for installation${NC}"
#__output " ${GREEN}Please Check if it looks OK${NC}"
#__output " ${ORANGE}^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^${NC}"
#__output " ${ORANGE}vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv${NC}"
#__output "  "
#        cat connection.yaml
#__output "  "
#__output " ${ORANGE}^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^${NC}"
#__output " ${GREEN}Current imconnectionsecret.yaml file for installation${NC}"
#__output " ${GREEN}Please Check if it looks OK${NC}"
#__output " ${ORANGE}vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv${NC}"
#__output "  "
#        cat imconnectionsecret.yaml
#__output "  "
#__output " ${ORANGE}^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^${NC}"
#__output "---------------------------------------------------------------------------------------------------------------------------"
#__output "---------------------------------------------------------------------------------------------------------------------------"
#__output "  "
#__output "  "
#__output "  "
#__output "  "
#__output "---------------------------------------------------------------------------------------------------------------------------"
#__output "---------------------------------------------------------------------------------------------------------------------------"
#__output " ${GREEN}Current registration.json file for installation${NC}"
#__output " ${GREEN}Please Check if it looks OK${NC}"
#__output " ${ORANGE}vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv${NC}"
#__output "  "
#        cat registration.json
#__output "  "
#__output "---------------------------------------------------------------------------------------------------------------------------"
#__output "---------------------------------------------------------------------------------------------------------------------------"
#__output "  "
#__output "  "
#__output "  "
#__output "  "


# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Creating Infrastructure Management Configurations
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
header3Begin "Creating Infrastructure Management Configurations" "rocket"
        


        oc delete connection -n management-infrastructure-management imconnection
        oc delete secret -n management-infrastructure-management imconnectionsecret


        oc create -n management-infrastructure-management -f ./connection.yaml
        oc create -n management-infrastructure-management -f ./imconnectionsecret.yaml


 header3End

# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Creating Infrastructure Management Instance
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
header3Begin "Creating Infrastructure Management Instance" "rocket"
        


        # oc delete -n management-infrastructure-management -f ./iminstall.yaml

        oc create -n management-infrastructure-management -f ./iminstall.yaml

 header3End


# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Registering Infrastructure Management with CP4MCM
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
header3Begin "Registering Infrastructure Management VM with CP4MCM" "rocket"
        
        
        __output "---------------------------------------------------------------------------------------------------------------------------"
        __output " ${RED}${rocket} Registering ${CYAN} Infrastructure Management VM${CYAN}${NC}" 

        MCM_PWD=$(oc -n ibm-common-services get secret platform-auth-idp-credentials -o jsonpath='{.data.admin_password}' | base64 -d)
        #MCM_PWD_TEMP="zAB5uhtA1GRx6tMtLexjpebpUXRGjEiS"
        __output " ${GREEN}Login to MCM Cluster${NC}"  

        LOGIN_OK=$(cloudctl login -a ${MCM_SERVER} --skip-ssl-validation -u ${MCM_USER} -p ${MCM_PWD} -n kube-system)
        if [[ $LOGIN_OK =~ "Error response from server" ]];
        then
          __output "    ${RED}ERROR${NC}: Could not login to MCM Hub on Cluster '$CLUSTER_NAME'. Aborting."
          exit 2
        else
          #cloudctl iam oauth-client-register -f registration.json
          __output "    ${GREEN}  OK${NC}"
          __output "  "
        fi

        __output " ${GREEN}Register OAUTH Client${NC}"
          cloudctl iam oauth-client-delete -f $CLIENT_ID
          cloudctl iam oauth-client-register -f $INSTALL_PATH/registration.json
        __output " ${GREEN}    OK${NC}"




      __output "---------------------------------------------------------------------------------------------------------------------------"
      __output " ${RED}${rocket} Integrating ${CYAN} Infrastructure Management VM${CYAN}${NC}" 
      __output "   ${magnifying} Check if ${CYAN}Component${NC} '${ORANGE}CloudForms${NC}' can be integrated"
      $SCRIPT_PATH/tools/navigation/automation-navigation-updates.sh -c https://$MIQ_URL


header3End








 headerModuleFileEnd "Post-Install Infrastructure VM" $0