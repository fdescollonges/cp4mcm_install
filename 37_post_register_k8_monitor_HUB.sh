# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# Install Kubernetes Monitoring
#
# V1.0 
#
# Â©2020 nikh@ch.ibm.com
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"

source ./99_config-global.sh


# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# Do Not Edit Below
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"


headerModuleFileBegin "Register Kubernetes Monitoring" $0

# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# INSTALL CHECKS
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
header3Begin "Install Checks"


        checkOpenshiftReachable

        checkAlreadyInstalled app=k8sdc-operator cp4mcm-cloud-native-monitoring
        if [[ $ALREADY_INSTALLED == 1 ]];
        then
            __output "    ${RED}${cross}Cluster already registered for monitoring! Skipping...${NC}"
            exit 0
        fi


header3End



# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Install Klusterlet
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
header3Begin "Install Monitoring Klusterlet" "rocket"

          oc create ns cp4mcm-cloud-native-monitoring
          oc patch cluster mcm-hub -n mcm-hub -p '{"metadata":{"labels":{"ibm.com/cloud-native-monitoring":"enabled"}}}'
          oc create secret docker-registry pull-secret-hub --docker-username=$ENTITLED_REGISTRY_USER --docker-password=$ENTITLED_REGISTRY_KEY --docker-email=demo@ibm.com --docker-server=$ENTITLED_REGISTRY -n cp4mcm-cloud-native-monitoring


        waitForPodsReady "cp4mcm-cloud-native-monitoring"


header3End

headerModuleFileEnd "Register Kubernetes Monitoring" $0

