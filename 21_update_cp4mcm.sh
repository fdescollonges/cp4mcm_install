# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# Installing Script for all CP4MCM components
#
# V2.0 
#
# Â©2020 nikh@ch.ibm.com
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"

source ./99_config-global.sh
export TEMP_PATH=$TMPDIR





# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# Do Not Edit Below
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
__output "${GREEN}***************************************************************************************************************************************************${NC}"
__output "${GREEN}***************************************************************************************************************************************************${NC}"
__output "${GREEN}***************************************************************************************************************************************************${NC}"
__output "${GREEN}***************************************************************************************************************************************************${NC}"
__output "  "
__output " ${CYAN} CloudPack for Multicloud Management 2.0 - ${RED}Update CP4MCM Features${NC}"
__output "  "
__output "${GREEN}***************************************************************************************************************************************************${NC}"
__output "${GREEN}***************************************************************************************************************************************************${NC}"
__output "${GREEN}***************************************************************************************************************************************************${NC}"
__output "  "
__output "  "



header1Begin "Starting"


# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# GET PARAMETERS
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
header3Begin "Input Parameters" "magnifying"

        while getopts "d:" opt
        do
          case "$opt" in
              d ) INPUT_PATH="$OPTARG" ;;
          esac
        done



        if [[ $INPUT_PATH == "" ]];
        then
            __output "       ${ORANGE}No Path provided, using${NC}             $TEMP_PATH"
        else
            __output "       ${GREEN}Temp Path${NC}                           $INPUT_PATH"
            export TEMP_PATH=$INPUT_PATH
        fi



header3End




# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# List Components
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
header3Begin "Components to be installed"  "magnifying"
__output "     You can adapt this in the 00_config file${NC}"
__output "${CYAN}---------------------------------------------------------------------------------------------------------------------------${NC}"

  printComponentsInstall

header3End






# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Install Checks
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
header3Begin "Install Checks"

        getClusterFQDN

        getInstallPath


        __output " ${wrench} Create Config Directory"
          export SCRIPT_PATH=$(pwd)
          mkdir -p $INSTALL_PATH 
        __output "    ${GREEN}  OK${NC}"
        __output "  "
      
header3End





header1End "Starting"



header1Begin "Updating CP4MCM"


  
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Adapt Config Files
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
header3Begin "Adapt Config Files" "magnifying"


        cd $INSTALL_PATH
        # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        # Backup vanilla config
        cp $SCRIPT_PATH/tools/0_prepare/CR/cp4mcm-cr.yaml ./cp4mcm-cr.yaml


        # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        # Adapt Config FIle
        # ---------------------------------------------------------------------------------------------------------------------------------------------------"
        ${SED} -i "s/<STORAGE_CLASS>/$STORAGE_CLASS_BLOCK/" ./cp4mcm-cr.yaml
        ${SED} -i "s/<NAMESPACE>/$CP4MCM_NAMESPACE/" ./cp4mcm-cr.yaml



        ${SED} -i "s/<INSTALL_INFRA_CAM>/$INSTALL_INFRA_CAM/" ./cp4mcm-cr.yaml
        ${SED} -i "s/<INSTALL_INFRA_VM>/$INSTALL_INFRA_VM/" ./cp4mcm-cr.yaml
        ${SED} -i "s/<INSTALL_INFRA_GRC>/$INSTALL_INFRA_GRC/" ./cp4mcm-cr.yaml
        ${SED} -i "s/<INSTALL_INFRA_SERVICE_LIBRARY>/$INSTALL_INFRA_SERVICE_LIBRARY/" ./cp4mcm-cr.yaml
        ${SED} -i "s/<INSTALL_MON_MONITORING>/$INSTALL_MON_MONITORING/" ./cp4mcm-cr.yaml
        ${SED} -i "s/<INSTALL_MCMNOT>/$INSTALL_MCMNOT/" ./cp4mcm-cr.yaml
        ${SED} -i "s/<INSTALL_MCMIMGSEC>/$INSTALL_MCMIMGSEC/" ./cp4mcm-cr.yaml
        ${SED} -i "s/<INSTALL_MCMMUT>/$INSTALL_MCMMUT/" ./cp4mcm-cr.yaml
        ${SED} -i "s/<INSTALL_MCMVUL>/$INSTALL_MCMVUL/" ./cp4mcm-cr.yaml
        ${SED} -i "s/<INSTALL_OPS_CHAT>/$INSTALL_OPS_CHAT/" ./cp4mcm-cr.yaml
        ${SED} -i "s/<INSTALL_TP_MNG_RT>/$INSTALL_TP_MNG_RT/" ./cp4mcm-cr.yaml


  

        ${SED} -i "s/<INSTALL_BLOCK_INFRA>/$INSTALL_BLOCK_INFRA/" ./cp4mcm-cr.yaml
        ${SED} -i "s/<INSTALL_BLOCK_MON>/$INSTALL_BLOCK_MON/" ./cp4mcm-cr.yaml
        ${SED} -i "s/<INSTALL_BLOCK_SEC>/$INSTALL_BLOCK_SEC/" ./cp4mcm-cr.yaml
        ${SED} -i "s/<INSTALL_BLOCK_OPS>/$INSTALL_BLOCK_OPS/" ./cp4mcm-cr.yaml
        ${SED} -i "s/<INSTALL_BLOCK_TP>/$INSTALL_BLOCK_TP/" ./cp4mcm-cr.yaml
        ${SED} -i "s/<DISABLE_MCM_CORE_INSTALL>/$DISABLE_MCM_CORE_INSTALL/" ./cp4mcm-cr.yaml



        __output ""
        __output " ${GREEN}DONE${NC}"
        
header3End




__output "${GREEN}---------------------------------------------------------------------------------------------------------------------------${NC}"
__output " ${GREEN}Current config file for installation${NC}"
__output " ${GREEN}Please Check if it looks OK${NC}"
__output " ${ORANGE}vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv${NC}"
__output "  "
        cat ./cp4mcm-cr.yaml
__output "  "
__output " ${ORANGE}^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^${NC}"
__output " ${GREEN}Current config file for installation${NC}"
__output " ${GREEN}Please Check if it looks OK${NC}"
__output "${GREEN}---------------------------------------------------------------------------------------------------------------------------${NC}"
__output "  "
__output "  "
__output "  "
__output "  "

__output "${GREEN}---------------------------------------------------------------------------------------------------------------------------${NC}"
__output " ${GREEN}Comparing with previous config file${NC}"
__output " ${ORANGE}vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv${NC}"
__output "  "

diff ./cp4mcm-cr.yaml ../20_install_cp4mcm.sh/cp4mcm-cr.yaml --context=1

__output "  "
__output " ${ORANGE}^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^${NC}"
__output "${GREEN}---------------------------------------------------------------------------------------------------------------------------${NC}"
__output "  "
__output "  "
__output "  "
__output "  "



# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# INSTALL
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
__output "---------------------------------------------------------------------------------------------------------------------------"
__output "---------------------------------------------------------------------------------------------------------------------------"
__output " ${ORANGE}Do you want to ${RED}UPDATE${ORANGE} CP4MCM in Cluster '$CLUSTER_NAME' with the above configuration?${NC}"
__output ""
__output "---------------------------------------------------------------------------------------------------------------------------"
__output "---------------------------------------------------------------------------------------------------------------------------"

        read -p "Update? [y,N]" DO_COMM
        if [[ $DO_COMM == "y" ||  $DO_COMM == "Y" ]]; then
          __output "${GREEN}OK${NC}"
          __output "${GREEN}Update config file in 20_install_cp4mcm_u${NC}"
          cp ../20_install_cp4mcm.sh/cp4mcm-cr.yaml ../20_install_cp4mcm.sh/cp4mcm-cr.yaml.bak_$(date +'%Y%m%d%H%M')
          cp ./cp4mcm-cr.yaml ../20_install_cp4mcm.sh/cp4mcm-cr.yaml
        else
          __output "${RED}Installation Aborted${NC}"
          exit 1
        fi

        

        
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Install CP4MCM
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
header3Begin "Update CP4MCM" "rocket"

        __output " ${wrench} Deploy CP4MCM with CR File"
        oc apply -n $CP4MCM_NAMESPACE -f ./cp4mcm-cr.yaml


header3End




header1End "Updating CP4MCM"











__output "${GREEN}----------------------------------------------------------------------------------------------------------------------------------------------------${NC}"
__output "${GREEN}----------------------------------------------------------------------------------------------------------------------------------------------------${NC}"
__output " ${GREEN}${healthy} Cloud Pak for Multicloud Management (CP4MCM) 2.0 Updated${NC}"
__output "${GREEN}----------------------------------------------------------------------------------------------------------------------------------------------------${NC}"
__output "${GREEN}----------------------------------------------------------------------------------------------------------------------------------------------------${NC}"
__output "${GREEN}----------------------------------------------------------------------------------------------------------------------------------------------------${NC}"
__output "${GREEN}----------------------------------------------------------------------------------------------------------------------------------------------------${NC}"
__output "${GREEN}----------------------------------------------------------------------------------------------------------------------------------------------------${NC}"
__output "${GREEN}----------------------------------------------------------------------------------------------------------------------------------------------------${NC}"
__output "${GREEN}***************************************************************************************************************************************************${NC}"
__output "${GREEN}***************************************************************************************************************************************************${NC}"


